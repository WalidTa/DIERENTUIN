@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "Assign Animals";
    var categoryName = ViewData["CategoryName"] as string ?? "";
    var categoryId = ViewData["CategoryId"];
}

<div class="mb-4">
    <h1>🏷️ Assign Animals to Category</h1>
    <p class="text-muted">@categoryName</p>
</div>

<div class="alert">
    Select the animals you want to assign to this category. Animals already assigned are pre-selected.
</div>

<form asp-action="AssignAnimals" asp-route-id="@categoryId" method="post">
    @Html.AntiForgeryToken()
    
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="selectAll" class="form-check-input" />
                            </th>
                            <th>Animal Name</th>
                            <th>Species</th>
                            <th>Current Category</th>
                            <th>Enclosure</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var animal in Model)
                        {
                            <tr class="clickable-row" style="cursor: pointer;">
                                <td>
                                    <input type="checkbox" 
                                           name="selectedAnimalIds" 
                                           value="@animal.Id" 
                                           class="form-check-input animal-checkbox"
                                           @(animal.IsAssigned ? "checked" : "") />
                                </td>
                                <td><strong>@animal.Name</strong></td>
                                <td>@animal.Species</td>
                                <td>
                                    @if (animal.Category != null)
                                    {
                                        <span class="badge bg-secondary">@animal.Category.Name</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">None</span>
                                    }
                                </td>
                                <td>
                                    @if (animal.Enclosure != null)
                                    {
                                        <span class="badge bg-info">@animal.Enclosure.Name</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">None</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-success">Save Assignments</button>
        <a asp-action="Index" class="btn btn-secondary">Cancel</a>
    </div>
</form>

@section Scripts {
    <script>
        // Select/Deselect all checkboxes
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.animal-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });

        // Update "Select All" checkbox state based on individual checkboxes
        function updateSelectAllState() {
            const allCheckboxes = document.querySelectorAll('.animal-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.animal-checkbox:checked');
            document.getElementById('selectAll').checked = allCheckboxes.length === checkedCheckboxes.length;
        }

        document.querySelectorAll('.animal-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectAllState);
        });

        // Make entire row clickable
        document.querySelectorAll('.clickable-row').forEach(row => {
            row.addEventListener('click', function(e) {
                // Don't toggle if clicking directly on the checkbox
                if (e.target.type === 'checkbox') {
                    return;
                }
                
                const checkbox = this.querySelector('.animal-checkbox');
                checkbox.checked = !checkbox.checked;
                updateSelectAllState();
            });
        });
    </script>
}
